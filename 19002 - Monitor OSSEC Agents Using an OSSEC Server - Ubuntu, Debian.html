<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">

<head>

<!--Article Number is 19002-->

<!--Use this template for articles that explain or describe something (such as an operating system). For articles that include steps for accomplishing a task (for example, installing), use the Informational template instead.  -->


<title>Monitor OSSEC Agents using OSSEC Server - Ubuntu, Debian</title>
<style type="text/css">
div.hacker {
background-color:#666;
border:1px solid #ccc;
color:#fff;
font-family:"Lucida Console","Courier New",Courier,fixed;  font-size:95%;  line-height:160%;  margin-bottom:1.5em;  padding:10px; }

p.note {
 background-color:#ffffe6;
 border:1px solid #eee;
 color:#666;
 padding:.8em 1.6em;
 margin:15px 0;
}

.warning {
 border: 1px #d25100 solid;
 padding: .5em 1em .5em 4em;
 margin: 10px 20px 15px 20px;
 background-image: url('@{help-img-path}/img_warning.gif');
 background-repeat: no-repeat;
 background-position: left top;
 background-color: #ededed;-moz-border-radius:
0.8em;-webkit-border-radius: 0.8em;
 /* -moz-border-bottom-radius: 0;9 */
 -webkit-border-bottom-radius: 0;
 padding-top:14px;
 padding-bottom:15px;
}
</style>


<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:ArticleKeywords msdt:dt="string">Security, Monitoring,</mso:ArticleKeywords>
<mso:Reference msdt:dt="string">https://www.digitalocean.com/community/tutorials/how-to-monitor-ossec-agents-using-an-ossec-server-on-ubuntu-14-04, https://www.digitalocean.com/community/tutorials/how-to-monitor-ossec-agents-using-an-ossec-server-on-ubuntu-14-04</mso:Reference>
<mso:LinuxDistributions msdt:dt="string">;#Ubuntu;#Debian;#</mso:LinuxDistributions>
<mso:ArticlePriority msdt:dt="string">10</mso:ArticlePriority>
<mso:RequestNotes msdt:dt="string"></mso:RequestNotes>
<mso:Difficulty msdt:dt="string">4</mso:Difficulty>
<mso:ForkSplit msdt:dt="string"></mso:ForkSplit>
<mso:ArticleID msdt:dt="string">19002</mso:ArticleID>
<mso:UnsupportedFeatures msdt:dt="string"></mso:UnsupportedFeatures>
<mso:Collapsed msdt:dt="string"></mso:Collapsed>
<mso:Complexity msdt:dt="string"></mso:Complexity>
<mso:ArticleStatus msdt:dt="string">Not started</mso:ArticleStatus>


<mso:Sample msdt:dt="string">z</mso:Sample>
<mso:DeliveryTarget msdt:dt="string"></mso:DeliveryTarget>
<mso:EditScore msdt:dt="string"></mso:EditScore>
<mso:PrereqOrdering msdt:dt="string">3</mso:PrereqOrdering>
<mso:AssignedTo1 msdt:dt="string">12</mso:AssignedTo1>
<mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1 msdt:dt="string">Tom Taylor</mso:display_urn_x003a_schemas-microsoft-com_x003a_office_x003a_office_x0023_AssignedTo1>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>

<body>
<p>Setting up OSSEC to monitor agents, Security, Monitoring,</p>
	<h1>Monitor OSSEC Agents using OSSEC Server - Debian,Ubuntu </h1>
	<p><strong>Difficulty: </strong> 4<br/>
	<strong>Time: </strong> 1 hour</p>
	<p>OSSEC is an open-source, host-based intrusion detection system. It performs log integrity checking, analysis, rootkit detection, Windows registry monitoring, active response and time based alerting. It can monitor one or more servers and can be configured to give real time alerts. This article explains how to monitor OSSEC agents with OSSEC server on Debian and Ubuntu.</p>
	<p class="note">
		You will need access to sudo privileges to complete all steps.
	</p>
	<!--prerequisites starts-->
	<h2>Prerequisites</h2>
	<ul>
		<li>
			Two separate Ubuntu droplets. One for Server and other for Agent. 
		</li>
		<li>
			<strong>Iptable</strong> should be enabled on both droplets.
		</li>
	</ul>
	<!--prerequisites ends-->
	
	<!--step1 starts-->
	<h2>Download OSSEC and verify on Server and Agent</h2>
	<ol>
		<li>
			Update the package database.
			<div class="hacker">
				sudo apt-get update
			</div>
		</li>
		<li>
			Install available updates: 
			<div class="hacker">
				sudo apt-get udgrade
			</div>
		</li>
		<li>
			Install following packages on server: 
			<div class="hacker">
				sudo apt-get install inotify-tools build-essential
			</div>
		</li>
		<li>
			Install following packages, on agent: 
			<div class="hacker">
				sudo apt-get install build-essential
			</div>
		</li>
		<li>
			Install the following packages on both servers to save any changes made in <strong>iptables</strong>.
			<div class="hacker">
				sudo apt-get install iptables-persistent
			</div>
			<p>It will ask if you would like to save current rules to be automatically loaded. To save your current configurations,
			press <strong>Enter</strong>.</p>
			<p>It will also ask if you want to save IPv6 rules you created.</p>
		</li>
		<li>
		Download OSSEC and its checksum file on both the droplets.
			<div class="hacker">
				
				wget -U ossec http://www.ossec.net/files/ossec-hids-2.8.1.tar.gz<br/>
				wget -U ossec http://www.ossec.net/files/ossec-hids-2.8.1-checksum.txt
				
			</div>
		</li>
		<li>
		Type the following command to verify md5sum of the compressed tarball.
			<div class="hacker">
				md5sum -c ossec-hids-2.8.1-checksum.txt
			</div>
			The putput should be:
			<div class="hacker">
			ossec-hids-2.8.1.tar.gz: OK<br/>
				md5sum: WARNING: 1 line is improperly formatted
			</div>
			Ignore the warning.
		</li>
		<li>
			Verify SHA1 of the compressed tarball using following command.
			<div class="hacker">
				sha1sum -c ossec-hids-2.8.1-checksum.txt
			</div>
			The output should be:
			<div class="hacker">
				ossec-hids-2.8.1.tar.gz: OK<br/>
				sha1sum: WARNING: 1 line is improperly formatted
			</div>
			Ignore the warnings.
		</li>
	</ol>
	<!--step1 ends-->
	<!--step2 starts-->
	<h2>Install the OSSEC Server</h2>
	<ol>
		<li>
			Type the following command to untar the file.
			<div class="hacker">
				sudo tar xf ossec-hids-2.8.1.tar.gz
			</div>
		</li>
		<li>
			Change directory to the one just expanded.
			<div class="hacker">
				cd ossec-hids-2.8.1/
			</div>
		</li>
		<li>
			Start the installation.
			<div class="hacker">
				sudo ./install.sh
			</div>
		</li>
		<li>
			During the installation it will prompt to answer a few questions, just press <strong>Enter</strong>
			to accept the default answers. The first question will be to choose a language, which is by default <strong>English(en)</strong>, press <strong>Enter</strong>
			to accept it.
		</li>
		<li>
			In the next question it will ask the type of installation, type <em><u>server</u></em> and press <strong>Enter</strong>.
			<div class="hacker">
				1- What kind of installation do you want (server, agent, local, hybrid or help)? <em><u>server</u></em>
			</div>
		</li>
		<li>
			
			Accept default for rest of the questions. Question on email should be answered with a valid email id, where all
			the notifications will be sent.
			
		</li>
		<li>
			
			After all the questions the installation will start. On successful installation following will be displayed.
			<div class="hacker">
				<pre>
				In order to connect agent and server, you need to add each agent to the server.
				Run the 'manage_agents' to add or remove them:

				/var/ossec/bin/manage_agents

				More information at:
				http://www.ossec.net/en/manual.html#ma
				</pre>
			</div>
		</li>
	</ol>

	<!--step2 ends-->
	<!--step3 starts-->
	<h2>Configure OSSEC Server</h2>
	OSSEC agent is not yet installed but server can be configured. 
	<ol>
		<li>
			Switch to the root user.
			<div class="hacker">
				sudo su
			</div>
		</li>
		<li>
			Change directory to the OSSEC's configuration file's directory.
			<div class="hacker">
				cd /var/ossec/etc
			</div>
		</li>
		<li>
			Open <code>ossec.conf</code> file.
			<div class="hacker">
				vim ossec.conf
			</div>
			On the top of this file there are a few fields. Following is the description of these fields.
			<ul>
				<li><code>&lt;email_to> </code>is the email you entered during installation.</li>
				<li><code>&lt;email_from> </code>is where the emails appear to be coming from.</li>
				<li>Change <code>&lt;smtp_server> </code> to localhost if you have your own email
				 server installed on same the host as OSSEC.</li>
			</ul>
			Update these settings as per your need. After all the changes, the section will look like:
			<div class="hacker">
				<pre>
				&lt;global>
					&lt;email_notification><em><u>yes</u></em>&lt;/email_notification>
					&lt;email_to><em><u>email@coolexample.com</u></em>&lt;/email_to>
					&lt;smtp_server><em><u>mail.coolexample.com</u></em>.&lt;/smtp_server>
					&lt;email_from><em><u>user@coolexample.com</u></em>&lt;/email_from>
				&lt;/global>
				</pre>
			</div>
		</li>
		<li>
			Save the file and close it by pressing <strong>ESC</strong> and following characters followed by pressing <strong>Enter</strong>.
			<div class="hacker">
				:wq
			</div>
		</li>
		<li>
			Start OSSEC.
			<div class="hacker">
				/var/ossec/bin/ossec-control start
			</div>
		</li>
	</ol>

	<!--step3 ends-->
	<!--step4 ends-->
	<h2>Install OSSEC Agent</h2>
	<ol>
		<li>
			Type the following command to untar the file.
			<div class="hacker">
				sudo tar xf ossec-hids-2.8.1.tar.gz
			</div>
		</li>
		<li>
			Change into the following directory:
			<div class="hacker">
				cd ossec-hids-2.8.1/
			</div>
		</li>
		<li>
			Start the installation.
			<div class="hacker">
				sudo ./install.sh
			</div>
		</li>
		<li>
			Most of the prompts are same as before, except a few. When asked about the type of installation, type <code>agent</code> and press <strong>Enter</strong>:
			
			<div class="hacker">
				1- What kind of installation do you want (server, agent, local, hybrid or help)? <em><u>agent</u></em>
			</div>
		</li>
		<li>
			When asked about the server IP address, type IP address of the server.
			<div class="hacker">
				3.1- What's the IP Address or hostname of the OSSEC HIDS server? : <em><u>server_ip</u></em>
			</div >
		</li>
		<li>
				For other questions, accept default by pressing <strong>Enter</strong>. On the successful following will be displayed.
			<div class="hacker">
				<pre>
					You first need to add this agent to the server so they
					can communicate with each other. When you have done so,
					you can run the 'manage_agents' tool to import the
					authentication key from the server.

					/var/ossec/bin/manage_agents

					More information at:
					http://www.ossec.net/en/manual.html#ma
				</pre>
			</div>
			Server and agent both have been installed but they can't communicate.
		</li>
	</ol>
	<!--step4 ends-->
	<!--step5 starts-->
	<h2>Add Agent to the Server</h2>
	<p class="note">
		You are already operating as a root from the previous step, so you don't need to use sudo now.
	</p>
	<ol>
		<li>
		Type following command:
			<div class="hacker">
				/var/ossec/bin/manage_agents
			</div>
		</li>
		<li>
			Type <strong>A</strong> and press <strong>Enter</strong> to add and agent.
			<div class="hacker">
				<pre>
				(A)dd an agent (A).
				(E)xtract key for an agent (E).
				(L)ist already added agents (L).
				(R)emove an agent (R).
				(Q)uit.
				Choose your action: A,E,L,R or Q: <em><u>a</u></em>
				</pre>
			</div>
		</li>
		<li>
			It will ask for agent's name, IP and its ID. Keep the name unique and enter the IP of the agent. For ID, you can accept the default value by pressing <strong>Enter</strong>:
			<div class="hacker">
				<pre>
				- Adding a new agent (use '\q' to return to the main menu).
				Please provide the following:
				* A name for the new agent: <em><u>agent-name</u></em>
				* The IP Address of the new agent: <em><u>ip_of_agent</u></em>
				* An ID for the new agent[001]:
				Agent information:
				ID:001
				Name:agentUbuntu
				IP Address: <em><u>ip_of_agent</u></em>

				Confirm adding it?(y/n):<em><u> y</u></em>
				Agent added.
				</pre>
			</div>
			It will return to main menu.
		</li>
		<li>
			 Press <strong>E</strong>, <strong>Enter</strong> and then give the ID of the agent to fetch the agent key. Make sure to make a note of it.
			<div class="hacker">
				<pre>
				Choose your action: A,E,L,R or Q: e

				Available agents:
				ID: 001, Name: <em><u>agent-name</u></em>, IP:<em><u>ip_of_agent</u></em>
				Provide the ID of the agent to extract the key (or '\q' to quit): 001

				Agent key information for '001' is:
				MDAxIGFnZW50VWJ1bnyEwNjI5MjI4ODBhMDkzMzA4MR1IXXwNC4yMzYuMjIyLjI1MSBiMTI2U3MTI4YWYzYzg4M2YyNTRlYzM5M2FmNGVhNDYTIwNDE3NDI1NWVkYmQw

				** Press ENTER to return to the main menu.
				</pre>
			</div>
		</li>
		<li>
			Press <strong>Enter</strong> to return to main menu and then <strong>Q</strong> to quit.
		</li>
	</ol>

	<!--step5 ends-->
	<!--step6 starts-->
	<h2>Import key to Agent from Server</h2>
	These actions are to be completed on <strong>Agent</strong>.
	<ol>
		<li>
			Switch to root.
			<div class="hacker">
				sudo su
			<div>
		</li>
		<li>
			Type following command.
			<div class="hacker">
				/var/ossec/bin/manage_agents
			</div>
		</li>
		<li>
			Chose <strong>I</strong> to import key:
			<div class="hacker">
				<pre>
				(I)mport key from the server (I).
				(Q)uit.
				Choose your action: I or Q: <em><u>i</u></em>
				</pre>
			</div>
			After choosing <strong>I</strong> follow the direction to paste the key from server and confirm when it asks.
		</li>
		<li>
			Press <strong>Enter</strong> to return to the main menu and choose <strong>Q</strong> to quit.
			<div class="hacker">
				<pre>
				Confirm adding it?(y/n): <em><u>y</u></em>
				Added.
				** Press ENTER to return to the main menu.
				</pre>
			</div>
		</li>
	</ol>

	<!--step6 ends-->
	<!--step7 starts-->
	<h2>Allow UDP Port 1514 traffic through firewalls</h2>
	<p>Communication on both sides takes place on UDP port 1514. To add a rule to <code>iptables</code> for both ends follow these steps.</p>
	<ol>
		<li>
			Remove the drop rule on both ends temporarily.
			<div class="hacker">
				sudo iptables -D INPUT -j DROP
			</div>
			If these is no drop rule,it will give message of <strong>bad rule</strong>.
		</li>
		<li>
			Use following command to add a rule at OSSEC server with agent's IP.
			<div class="hacker">
				iptables -A INPUT -p UDP --dport 1514 -s <em><u>ip_of_agent</u></em> -j ACCEPT
			</div>
		</li>
		<li>
			Use following command to add a rule on agent's side with server's IP.
			<div class="hacker">
				iptables -A INPUT -p UDP --dport 1514 -s <em><u>ip_of_server</u></em> -j ACCEPT
			</div>
		</li>
		<li>
			Type the following command to save changes of <strong>iptable</strong>:
			<div class="hacker">
			sudo invoke-rc.d iptables-persistent save
			</div>
		</li>
	</ol>
	<!--step7 ends-->
	<!--step8 starts-->
	<h2>Restart OSSEC Agent and Server</h2>
	<ul>
		<li>
			Restart both the servers
			<div class="hacker">
				/var/ossec/bin/ossec-control restart
			</div>
		
			OSSEC agent can be started from server using the following command:
			<div class="hacker">
				/var/ossec/bin/agent_control -R <em><u>001</u></em>
			</div>
			001 is the agent ID. Following message will be displayed.
			<div class="hacker">
				<em><u>agent-name</u></em>-<em><u>ip_of_agent</u></em> is active.
			</div>
		</li>
	</ul>
	<!--step8 ends-->
	<h2>Nest Steps</h2>
	<p>
		After following all these steps, email alerts should be received from both the ends. Settings may be further customized 
		for file addition or real time alerts. For configuration settings refer to <a href="18476 - Install and Configure OSSEC Security Notifications - Ubunut, Debian">Install and Configure OSSEC Security Notifications - Ubuntu, Debian</a>
	</p>
	<p>
		To monitor more than two droplets, add them as OSSEC agents using same steps as explained. If any issue occurs during set up, go through the logs in <code>/var/ossec/logs/ossec.log</code> file.
	</p>
</body>
</html>